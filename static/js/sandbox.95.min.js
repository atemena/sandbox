(function(){"use strict";var e=function(e){this.rect={x:0,y:0,width:0,height:0};this.stroke={color:"#00000000",width:0,alpha:0};this.color="#00000000";this.gradient={colors:[],direction:"none",colorStops:[],startX:0,startY:0,endX:0,endY:0};this.padding=0;this.curve=0;this.alpha=0;this.rotation=0;this.resizingMask=0;this.shadow={horizontalOffset:0,verticalOffset:0,blur:0,color:"rgba(0,0,0,1)"};this.image=new t;this.text=new n;this.subgroups=[];this.name;this.ko;this.shapeKO;this.parent;this.minimumSize={width:0,height:0};this.margins={left:0,right:0,top:0,bottom:0};this.copyValues=function(e){_.extend(this.rect,e.rect);_.extend(this.shadow,e.shadow);_.extend(this.gradient,e.gradient);this.image.copyValues(e.image);this.text.copyValues(e.text);_.map(_.pairs(e),function(e){var t=e[0];var n=e[1];if(typeof n!=="object"&&t!=="subgroups"){this[t]=n}},this)};this.setName=function(e){if(typeof e==="string")this.name=e};this.setPadding=function(e){if(e>=0){this.padding=e;this.resizeShape()}};this.setResizingMask=function(e){if(e>=0&&e<64)this.resizingMask=e};this.setImageMode=function(e){if(e==="center"||e==="scaleToFill"||e==="scaleAspectFit")this.image.mode=e};this.kineticToGroup=function(){this.updateRect();if(this.hasOwnProperty("shapeKO")){this.color=this.shapeKO.fill();this.rotation=this.shapeKO.rotation();this.stroke={color:this.shapeKO.stroke(),width:this.shapeKO.strokeWidth(),stroke:this.shapeKO.strokeAlpha()};this.alpha=this.shapeKO.fillAlpha();this.shadow={horizontalOffset:this.shapeKO.shadowOffsetX(),verticalOffset:this.shapeKO.shadowOffsetY(),blur:this.shapeKO.shadowBlur(),color:this.shapeKO.shadowColor()};var e=[];var t=[];if(this.shapeKO.fillPriority()!=="color"){var n=this.shapeKO.fillLinearGradientColorStops();for(var r=0;r<this.shapeKO.fillLinearGradientColorStops().length;r++){if(r%2==1)e.push(n[r]);else t.push(n[r])}this.gradient.colors=e;this.gradient.colorStops=t;if(this.shapeKO.fillPriority()==="linear"){this.gradient.startX=this.shapeKO.fillLinearGradientStartPoint().x;this.gradient.startY=this.shapeKO.fillLinearGradientStartPoint().y;this.gradient.endX=this.shapeKO.fillLinearGradientEndPoint().x;this.gradient.endY=this.shapeKO.fillLinearGradientEndPoint().y}else if(this.shapeKO.fillPriority()==="radial"){this.gradient.startX=this.shapeKO.getWidth()/2;this.gradient.startY=this.shapeKO.getHeight()/2;this.gradient.endX=this.shapeKO.getWidth();this.gradient.endY=this.shapeKO.getHeight()}}}if(this.getMainNode()){if(this.getMainNode().getClassName()==="Image")this.image.kineticToImg();else if(this.getMainNode().getClassName()==="Text")this.text.kineticToTxt()}};this.groupToKinetic=function(){this.shapeKO.setWidth(this.shapeWidth);this.shapeKO.setHeight(this.shapeHeight);this.shapeKO.setFill(this.color);this.rotate(this.rotation);this.shapeKO.stroke(this.stroke.color);this.shapeKO.strokeWidth(this.stroke.width);this.shapeKO.strokeAlpha(this.stroke.alpha);this.shapeKO.opacity(this.alpha);this.shapeKO.shadowColor(this.shadow.color);this.shapeKO.shadowBlur(this.shadow.blur);this.shapeKO.shadowOffset({x:this.shadow.horizontalOffset,y:this.shadow.verticalOffset})};this.rotate=function(e){if(this.ko.getParent().getClassName()==="Group"){if(!e)e=0;if(this.getMainNode())this.getMainNode().setRotationDeg(parseFloat(e));if(this.hasOwnProperty("shapeKO"))this.shapeKO.setRotationDeg(parseFloat(e));for(var t=0;t<this.subgroups.length;t++){this.subgroups[t].rotate(e)}this.rotation=e;canvas.mainLayer.batchDraw()}};this.resizeShape=function(){if(canvas.autoSize==true&&this.hasOwnProperty("shapeKO")&&this.getMainNode())this.editShape({width:this.getMainNode().getWidth()+this.padding,height:this.getMainNode().getHeight()})};this.textColor=function(e){if(this.text.ko){this.text.ko.fill(e);this.text.color=e;canvas.mainLayer.batchDraw()}};this.textFont=function(e){if(this.text.ko){this.text.ko.fontFamily(e);this.text.font=e;this.text.ko.setOffsetX(this.text.ko.getWidth()/2);this.text.ko.setOffsetY(this.text.ko.getHeight()/2);this.resizeShape();canvas.mainLayer.batchDraw()}};this.textContent=function(e){if(this.text.ko){this.text.ko.text(e);this.text.content=e;this.text.ko.setOffsetX(this.text.ko.getWidth()/2);this.text.ko.setOffsetY(this.text.ko.getHeight()/2);this.resizeShape();canvas.mainLayer.batchDraw()}};this.textAlign=function(e){if(this.text.ko){this.text.ko.align(e);this.text.ko.setOffsetX(this.text.ko.getWidth()/2);this.text.ko.setOffsetY(this.text.ko.getHeight()/2);this.text.justification=e;canvas.mainLayer.batchDraw()}};this.textSize=function(e){if(this.text.ko){this.text.ko.fontSize(e);this.text.size=e;this.text.ko.setOffsetX(this.text.ko.getWidth()/2);this.text.ko.setOffsetY(this.text.ko.getHeight()/2);this.resizeShape();canvas.mainLayer.batchDraw()}};this.shapeGradient=function(e){e=e||{};if(this.hasOwnProperty("shapeKO")){_.extend(this,e);var t=this.gradient.direction;var n=this.gradient.startX;var r=this.gradient.startY;var i=this.gradient.endX;var s=this.gradient.endY;var o=this.gradient.colors;var u=this.gradient.colorStops;var a=[];for(var f=0;f<o.length&&f<u.length;f++){a.push(u[f]);a.push(o[f])}var l={"linear-horizontal":[0,this.shapeKO.getHeight()/2,this.shapeKO.getWidth(),this.shapeKO.getHeight()/2],"linear-vertical":[this.shapeKO.getWidth()/2,0,this.shapeKO.getWidth()/2,this.shapeKO.getHeight()],"linear-horizontal-circle":[-this.shapeKO.getWidth()/2,0,this.shapeKO.getWidth()/2,0],"linear-vertical-circle":[0,-this.shapeKO.getHeight()/2,0,this.shapeKO.getHeight()/2],radial:[this.shapeKO.getWidth()/2,this.shapeKO.getHeight()/2,this.shapeKO.getWidth(),this.shapeKO.getHeight()]};if(!e.hasOwnProperty("startX")||!e.hasOwnProperty("startY")||!e.hasOwnProperty("endX")||!e.hasOwnProperty("endY")){var c=t;if(this.curve===-1&&c!="radial")c=c+"-circle";n=l[c][0];r=l[c][1];i=l[c][2];s=l[c][3]}if(t==="linear-vertical"||t==="linear-horizontal"){this.shapeKO.fillLinearGradientStartPoint({x:n,y:r});this.shapeKO.fillLinearGradientEndPoint({x:i,y:s});this.shapeKO.fillLinearGradientColorStops(a);this.shapeKO.fillPriority("linear-gradient")}else if(t==="radial"){var h=Math.sqrt((i-n)*(i-n)+(s-r)*(s-r));this.shapeKO.fillRadialGradientStartRadius(3);this.shapeKO.fillRadialGradientEndRadius(h);if(this.curve>=0){this.shapeKO.fillRadialGradientStartPoint({x:this.shapeKO.width/2,y:this.shapeKO.height/2});this.shapeKO.fillRadialGradientEndPoint({x:this.shapeKO.width/2,y:this.shapeKO.height/2})}this.shapeKO.fillRadialGradientColorStops(a);this.shapeKO.fillPriority("radial-gradient")}}canvas.mainLayer.batchDraw()};this.shapeFill=function(e){var t=this.color;if(e)t=e;if(typeof e==="string")this.shapeKO.fill(t)};this.vcenter=function(){if(this.selectedGroup.ko.getParent().getClassName()==="Group"){var e=canvas.stage.getHeight();this.ko.setY(e/2);this.rect.y=this.ko.y();canvas.mainLayer.batchDraw()}};this.hcenter=function(){if(this.selectedGroup.ko.getParent().getClassName()==="Group"){var e=canvas.stage.getWidth();this.ko.setX(e/2);this.rect.x=this.ko.x();canvas.mainLayer.batchDraw()}};this.moveUp=function(){if(this.selectedGroup.ko.getParent().getClassName()==="Group"){this.ko.moveUp();canvas.mainLayer.batchDraw()}};this.moveDown=function(){if(this.selectedGroup.ko.getParent().getClassName()==="Group"){this.ko.moveDown();canvas.mainLayer.batchDraw()}};this.shadowEdit=function(e){var t=this.getMainNode();if(this.hasOwnProperty("shapeKO")){if(t){t.shadowOpacity(0);t.shadowOffset({x:0,y:0})}t=this.shapeKO}if(t){if(e.hasOwnProperty("color"))t.shadowColor(e.color);if(e.hasOwnProperty("blur"))t.shadowBlur(e.blur);if(e.hasOwnProperty("horizontalOffsetX"))t.shadowOffsetX(e.horizontalOffsetX);if(e.hasOwnProperty("verticalOffsetY"))t.shadowOffsetY(e.verticalOffsetY);if(e.hasOwnProperty("opacity"))t.shadowOpacity(e.opacity);this.shadow={horizontalOffset:t.shadowOffsetX(),verticalOffset:t.shadowOffsetY(),blur:t.shadowBlur(),color:t.shadowColor()}}canvas.mainLayer.batchDraw()};this.editImage=function(e){if(canvas.selectedGroup){if(this.image.ko){var t=new Image;if(config.url.substr(0,5)!=="data:")t.crossOrigin="Anonymous";t.src=config.url;this.image.ko.setImage(t);canvas.mainLayer.batchDraw();this.resizeShape()}}};this.editShape=function(e){if(this.shapeKO){var t;var n=this;e.width=e.width||n.shapeKO.getWidth();e.height=e.height||n.shapeKO.getHeight();e.curve=e.curve||n.curve;e.fill=e.fill||n.color;if(!e.hasOwnProperty("stroke")){e.stroke=n.stroke.color;e.strokeWidth=n.stroke.width;e.strokeAlpha=n.stroke.alpha}else{e.strokeWidth=e.stroke.width||n.stroke.width;e.strokeAlpha=e.stroke.alpha||n.stroke.alpha;e.stroke=e.stroke.color||n.stroke.color}this.shapeKO.fillPriority("color");if(e.curve>=0){t=new Kinetic.Shape(canvas._extendConfig({sceneFunc:function(t){t.beginPath();t.moveTo(e.curve,0);t.lineTo(e.width-e.curve,0);t.quadraticCurveTo(e.width,0,e.width,e.curve);t.lineTo(e.width,e.height-e.curve);t.quadraticCurveTo(e.width,e.height,e.width-e.curve,e.height);t.lineTo(e.curve,e.height);t.quadraticCurveTo(0,e.height,0,e.height-e.curve);t.lineTo(0,e.curve);t.quadraticCurveTo(0,0,e.curve,0);t.fillStrokeShape(this)},x:n.shapeKO.getX(),y:n.shapeKO.getY(),draggable:false},e));t.setOffsetX(t.getWidth()/2);t.setOffsetY(t.getHeight()/2)}else if(e.curve==-1){t=new Kinetic.Ellipse(canvas._extendConfig({radius:{x:e.width/2,y:e.height/2},x:n.shapeKO.getX(),y:n.shapeKO.getY(),draggable:false},e))}this.ko.add(t);var r=this.shapeKO.getWidth();var i=this.shapeKO.getHeight();var s=this.shapeKO.fillPriority();this.shapeKO.destroy();this.shapeKO=t;if(s==="color"){this.shapeFill(e.fill)}else if(s==="linear-gradient"||s==="radial-gradient"){this.shapeGradient(e.gradient)}this.shapeKO.moveToBottom();this.scaleMainNode(t.getWidth()-r,t.getHeight()-i);this.shapeWidth=e.width;this.shapeHeight=e.height;this.color=e.fill;this.stroke.color=e.stroke;this.stroke.width=e.strokeWidth;this.stroke.alpha=e.strokeAlpha;this.curve=e.curve;this.shadow={horizontalOffset:e.shadowOffsetX,verticalOffset:e.shadowOffsetY,blur:e.shadowBlur,color:e.shadowColor};canvas.mainLayer.batchDraw()}};this.updateRect=function(){this.rect.x=this.ko.x();this.rect.y=this.ko.y();var e;if(this.hasOwnProperty("shapeKO"))e=this.shapeKO.getWidth();if(this.getMainNode()){if(this.getMainNode().getWidth()>e)e=this.getMainNode().getWidth()}if(!e)e=this.rect.width;var t;if(this.hasOwnProperty("shapeKO"))t=this.shapeKO.getHeight();if(this.getMainNode()){if(this.getMainNode().getHeight()>t)t=this.getMainNode().getHeight()}if(!t)t=this.rect.height;if(this.rect.width!=e||this.rect.height!=t){this.rect.width=e;this.rect.height=t}};this.updateMargins=function(){this.margins.left=this.shapeKO.getAbsolutePosition().x-this.shapeKO.getWidth()/2;this.margins.top=this.shapeKO.getAbsolutePosition().y-this.shapeKO.getHeight()/2;this.margins.right=canvas.stage.getWidth()-(this.shapeKO.getAbsolutePosition().x+this.shapeKO.getWidth()/2);this.margins.bottom=canvas.stage.getHeight()-(this.shapeKO.getAbsolutePosition().y+this.shapeKO.getHeight()/2)};this.getMainNode=function(e){for(var t=0;t<this.ko.getChildren().length;t++){if(this.ko.children[t].getClassName()==="Image"||this.ko.children[t].getClassName()==="Text"){return this.ko.children[t]}}return false};this.ungroup=function(){var e=this;if(e.parent!="root"){var t=e.parent;if(t.parent!="root"){var n=t.parent;n.subgroups.push(e);if(t.subgroups.indexOf(e)>-1)t.subgroups.splice(t.subgroups.indexOf(e),1);e.rect.x=e.rect.x+t.rect.x;e.rect.y=e.rect.y+t.rect.y;var r=t.ko.getZIndex();e.ko.remove();n.ko.add(e.ko);e.ko.setZIndex(r+1);e.ko.setX(e.ko.x()+t.rect.x);e.ko.setY(e.ko.y()+t.rect.y);canvas.mainLayer.batchDraw()}}};this.scaleMainNode=function(e,t){if(this.getMainNode()){if(this.getMainNode().getClassName()==="Image"){if(this.image.hasOwnProperty("mode")){var n;var r;if(this.hasOwnProperty("shapeKO")){if(this.shapeKO.getClassName()==="Ellipse"){var i=45;n=2*this.shapeKO.radiusX()*Math.cos(i*Math.PI/180);r=2*this.shapeKO.radiusY()*Math.sin(i*Math.PI/180)}else{r=this.shapeKO.getHeight();n=this.shapeKO.getWidth()}if(this.image.mode==="center"){}else if(this.image.mode==="scaleToFill"){this.image.ko.setWidth(n+e-2*this.padding);this.image.ko.setHeight(r+t);this.image.ko.setOffsetX(n/2);this.image.ko.setOffsetY(r/2);this.image.ko.setX(this.shapeKO.getX()+this.padding);this.image.ko.setY(this.shapeKO.getY())}else if(this.image.mode==="scaleAspectFit"){if(r<=n-2*this.padding){var s=this.image.ko.getHeight();this.image.ko.setHeight(r+t);this.image.ko.setOffsetY(this.image.ko.getHeight()/2);this.image.ko.setWidth(this.image.ko.getWidth()*(this.image.ko.getHeight()/s));this.image.ko.setOffsetX(this.image.ko.getWidth()/2)}else{var o=this.image.ko.getWidth();this.image.ko.setWidth(n+e-2*this.padding);this.image.ko.setOffsetX(this.image.ko.getWidth()/2);this.image.ko.setHeight(this.image.ko.getHeight()*(this.image.ko.getWidth()/o));this.image.ko.setOffsetY(this.image.ko.getHeight()/2)}}else if(this.image.mode==="scaleAspectFill"){if(r>n-2*this.padding){var s=this.image.ko.getHeight();this.image.ko.setHeight(r+t);this.image.ko.setOffsetY(this.image.ko.getHeight()/2);this.image.ko.setWidth(this.image.ko.getWidth()*(this.image.ko.getHeight()/s));this.image.ko.setOffsetX(this.image.ko.getWidth()/2)}else{var o=this.image.ko.getWidth();this.image.ko.setWidth(n+e-2*this.padding);this.image.ko.setOffsetX(this.image.ko.getWidth()/2);this.image.ko.setHeight(this.image.ko.getHeight()*(this.image.ko.getWidth()/o));this.image.ko.setOffsetY(this.image.ko.getHeight()/2)}}}}}}}};var t=function(){this.ko;this.imageId;this.url;this.tint="none";this.mode="scaleAspectFit";this.copyValues=function(e){_.extend(this,e)};this.kineticToImg=function(){this.url=this.ko.getImage().src}};var n=function(){this.ko;this.content="preview";this.color="rgba(0,0,0,1)";this.size=32;this.font="News Cycle";this.justification="center";this.style;this.copyValues=function(e){var t;_.extend(this,e);var n};this.kineticToTxt=function(){this.content=this.ko.getText();this.color=this.ko.fill();this.size=this.ko.fontSize();this.font=this.ko.fontFamily();this.justification=this.ko.align();this.style=this.ko.fontStyle()}};var r=function(t,n){return function(r,i,s,o){if(!o)o={};o.container=r;o.width=i;o.height=s;this.stage=new n.Stage(o);this.mainLayer=new n.Layer;this.border=new n.Rect({x:0,y:0,width:this.stage.attrs.width,height:this.stage.attrs.height,stroke:"black",strokeWidth:1});this.rootGroup;this.mainLayer.add(this.border);this.stage.add(this.mainLayer);this.mainLayer.batchDraw();this.selectedGroup;this.secondaryGroups=[];this.autoSize=true;this.rgbaStringToHex=function(e){var t=e.split("(")[1].split(")")[0];t=t.split(",");var n=t.map(function(e){e=parseInt(e).toString(16);return e.length==1?"0"+e:e});return"#"+n.join("")};this.hexToRGBAString=function(e,t){if(e[0]==="#"){e=e.slice(1,e.length)}return"rgba("+parseInt(e.slice(0,2),16)+","+parseInt(e.slice(2,4),16)+","+parseInt(e.slice(4,6),16)+","+parseInt(e.slice(6,8),16)+")"};this.loadImages=function(e,t,n,r){var s;if(typeof e==="string")e=document.getElementById(e);for(s=0;s<t.length;s++){if(r){var o=document.createElement("div");var u=r.replace(/%url/g,t[s].url).replace(/%caption/g,t[s].caption);o.innerHTML=u;var a=o.childNodes.length;for(var f=0;f<a;++f)e.appendChild(o.childNodes[0])}else{var l=document.createElement("img");var c=document.createElement("br");var h=document.createElement("br");l.src=t[s].url;l.style.width=i/2+"px";l.style.cursor="pointer";e.appendChild(l);e.appendChild(c);e.appendChild(h)}}var p=e.getElementsByTagName("img");for(s=0;s<p.length;++s)p[s].addEventListener("click",this._createEventListener(n))};this.loadFonts=function(e,n){if(typeof e==="string")e=document.getElementById(e);var r=[];for(var i=0;i<n.length;++i)r.push(n[i].family);window.WebFontConfig={google:{families:r},loading:function(){if(e){e.disabled=true;t(e).html("<option>Loading...</option>")}},active:function(){if(e){t(e).empty();for(var r=0;r<n.length;++r){var i=document.createElement("option");i.value=n[r].name;i.textContent=n[r].name;i.style.fontFamily=n[r].name;t(e).append(i)}e.disabled=false}}};(function(){var e=document.createElement("script");e.src=("https:"===document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";e.type="text/javascript";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()};this._selectGroup=function(e){if(this.selectedGroup!==e){this.selectedGroup=e}};this._addToSelected=function(e){for(var t=0;t<secondaryGroups.length;t++){if(secondaryGroups[t]!==e){secondaryGroups.append(e);break}}};this._extendConfig=function(e,t){if(t){for(var n in t){if(t.hasOwnProperty(n))e[n]=t[n]}}return e};this.addSubgroup=function(t){var r=this;var i=new e;if(t){i.copyValues(t)}i.ko=new n.Group({draggable:true,x:i.rect.x,y:i.rect.y});if(r.hasOwnProperty("selectedGroup")){r.selectedGroup.ko.add(i.ko);i.parent=r.selectedGroup;r.selectedGroup.subgroups.push(i);i.ko.on("mouseup dragstart",function(){r._selectGroup(i);i.kineticToGroup()});i.ko.on("mouseout",function(){document.body.style.cursor="auto"});i.ko.on("mouseover",function(){document.body.style.cursor="move"})}else{r.rootGroup=i;i.ko.draggable(false);if(i.rect.width===0){i.ko.setWidth(this.stage.getWidth());i.rect.width=this.stage.getWidth()}if(i.rect.height===0){i.ko.setHeight(this.stage.getHeight());i.rect.height=this.stage.getHeight()}r.mainLayer.add(i.ko);r.scale(i.rect.width,i.rect.height);i.parent="root"}r._selectGroup(i)};this.addSiblingGroup=function(t){var r=this;var i=new e;if(t){i.copyValues(t)}if(r.hasOwnProperty("selectedGroup")){if(r.selectedGroup.ko.getParent().getClassName()==="Group"){i.ko=new n.Group({draggable:true,x:i.rect.x,y:i.rect.y});r.selectedGroup.ko.getParent().add(i.ko);r.selectedGroup.parent.subgroups.push(i);i.parent=r.selectedGroup.parent;i.ko.on("mouseup dragstart",function(){r._selectGroup(i);i.kineticToGroup()});i.ko.on("mouseout",function(){document.body.style.cursor="auto"});i.ko.on("mouseover",function(){document.body.style.cursor="move"});r._selectGroup(i)}}};this.onImageLoad=function(e){var t=e[0];var r=e[1];var i=e[2];var s=new n.Image(this._extendConfig({image:r,x:0,y:0,draggable:false},i));s.offsetX(r.width/2);s.offsetY(r.height/2);t.ko.add(s);if(t.parent==="root"){s.setX(this.stage.getWidth()/2);s.setY(this.stage.getHeight()/2)}else{if(!t.hasOwnProperty("shapeKO")&&i.x==="auto"&&i.y==="auto"){i=this.randomPos(s)}else if(i.x==="auto"&&i.y==="auto"){s.setX(t.shapeKO.getWidth()/2);s.setY(t.shapeKO.getHeight()/2)}}t.updateRect();if(t.hasOwnProperty("shapeKO"))s.shadowOpacity(0);t.image.mode=i.mode||"scaleAspectFit";t.image.url=r.src;t.image.ko=s;t.kineticToGroup();this.relayer(t);this.mainLayer.batchDraw()};this.addImage=function(e,t){var r=this;var i=new Image;var s={x:"auto",y:"auto"};if(t){if(t.hasOwnProperty("rect")){if(t.rect.hasOwnProperty("width"))s.x=t.rect.width/2;if(t.rect.hasOwnProperty("height"))s.y=t.rect.height/2}if(t.hasOwnProperty("image")){if(t.image.hasOwnProperty("mode"))s.mode=t.image.mode}}if(!r.selectedGroup||r.selectedGroup.parent==="root"&&r.selectedGroup.getMainNode()){r.addSubgroup()}else if(r.selectedGroup.getMainNode()&&r.selectedGroup.parent!=="root"){r.addSiblingGroup()}if(typeof e!=="string")e=e.target.src;if(e.slice(-4)===".svg"||e.substr(0,26)==="data:image/svg+xml;base64,"){i.onload=function(){if(e.substr(0,26)==="data:image/svg+xml;base64,")e=atob(e.slice(26));var t=new n.Shape(r._extendConfig({drawFunc:function(t){t=t._context;t.shadowBlur=4;t.shadowOffsetY=6;t.shadowOffsetX=6;t.shadowColor="rgba(0,0,0,0.3)";t.drawSvg(e,0,0,i.width,i.height)},x:Math.floor(Math.random()*(325-75+1))+75,y:Math.floor(Math.random()*(225-75+1))+75,offset:{x:i.width/2,y:i.height/2},width:i.width,height:i.height,draggable:true,drawHitFunc:function(e){e.beginPath();e.moveTo(0,0);e.lineTo(i.width,0);e.lineTo(i.width,i.height);e.lineTo(0,i.height);e.lineTo(0,0);e.closePath();e.fillStrokeShape(this)}},s));t.on("mouseup dragstart",function(){r._selectNode(this)});t.on("mouseout",function(){document.body.style.cursor="auto"});t.on("mouseover",function(){document.body.style.cursor="move"});r._selectNode(t);r.scale(1);r.stickerLayer.add(t);r.stickerLayer.batchDraw()}}else{i.onload=this.onImageLoad.bind(r,[r.selectedGroup,i,s])}if(e.substr(0,5)!=="data:")i.crossOrigin="Anonymous";i.src=e};this.addText=function(e){var t=this;var r={x:"auto",y:"auto",text:"preview",fill:"rgba(0,0,0,1)",fontSize:32,fontFamily:"Arial"};if(e.hasOwnProperty("text")){var i={content:"text",color:"fill",size:"fontSize",font:"fontFamily",justification:"align",style:"style"};_.map(_.pairs(e.text),function(e){var t=e[0];var n=e[1];if(typeof n!=="object"&&t!=="subgroups"){if(t==="color")t="fill";r[i[t]]=n}});if(e.hasOwnProperty("rect")){if(e.rect.hasOwnProperty("width"))r.x=e.rect.width/2;if(e.rect.hasOwnProperty("height"))r.y=e.rect.height/2}}if(e.hasOwnProperty("shadow")){if(e.hasOwnProperty("horizontalOffsetX"))r.shadowOffsetX=e.shadow.horizontalOffsetX;if(e.hasOwnProperty("verticalOffsetY"))r.shadowOffsetY=e.shadow.verticalOffsetY;if(e.hasOwnProperty("blur"))r.shadowBlur=e.shadow.blur;if(e.hasOwnProperty("color"))r.shadowColor=e.shadow.color}if(!t.selectedGroup||t.selectedGroup.parent==="root"&&t.selectedGroup.getMainNode()){t.addSubgroup()}else if(t.selectedGroup.getMainNode()){t.addSiblingGroup()}var s=new n.Text(t._extendConfig({x:0,y:0,textBaseline:"middle",draggable:false},r));t.selectedGroup.ko.add(s);s.setOffsetX(s.getWidth()/2);s.setOffsetY(s.getHeight()/2);if(t.selectedGroup.parent==="root"){s.setX(t.stage.getWidth()/2);s.setY(t.stage.getHeight()/2)}else{if(!t.selectedGroup.hasOwnProperty("shapeKO")&&r.x==="auto"&&r.y==="auto"){t.randomPos(s)}else if(r.x==="auto"&&r.y==="auto"){s.setX(t.selectedGroup.shapeKO.getWidth()/2);s.setY(t.selectedGroup.shapeKO.getHeight()/2)}}if(e.hasOwnProperty("shapeKO"))s.shadowOpacity(0);t.selectedGroup.text.ko=s;t.selectedGroup.kineticToGroup();t.mainLayer.batchDraw()};this.addShape=function(e){var t;var r=this;var i={x:"auto",y:"auto",width:"auto",height:"auto",curve:0,fill:"#000000ff",stroke:"#ffffffff",strokeWidth:1,padding:10,resizingMask:0,opacity:1};_.map(_.pairs(e),function(e){var t=e[0];var n=e[1];if(typeof n!=="object"&&t!=="subgroups"){if(t==="color")t="fill";if(t==="alpha")t="opacity";i[t]=n}});if(e.hasOwnProperty("stroke")){if(e.stroke.hasOwnProperty("color"))i.stroke=e.stroke.color;if(e.stroke.hasOwnProperty("width"))i.strokeWidth=e.stroke.width;if(e.stroke.hasOwnProperty("alpha"))i.strokeAlpha=e.stroke.alpha}if(e.hasOwnProperty("rect")){if(e.rect.hasOwnProperty("width")){i.width=e.rect.width;if(e.rect.width!="auto")i.x=e.rect.width/2}if(e.rect.hasOwnProperty("height")){i.height=e.rect.height;if(e.rect.height!="auto")i.y=e.rect.height/2}}if(e.hasOwnProperty("shadow")){if(e.shadow.hasOwnProperty("horizontalOffsetX"))i.shadowOffsetX=e.shadow.horizontalOffsetX;if(e.shadow.hasOwnProperty("verticalOffsetY"))i.shadowOffsetY=e.shadow.verticalOffsetY;if(e.shadow.hasOwnProperty("blur"))i.shadowBlur=e.shadow.blur;if(e.shadow.hasOwnProperty("color"))i.shadowColor=e.shadow.color}if(!r.selectedGroup||r.selectedGroup.parent==="root"&&r.selectedGroup.shapeKO){r.addSubgroup()}else if(r.selectedGroup.shapeKO){r.addSiblingGroup()}if(i.width==="auto"||i.height==="auto"){if(r.selectedGroup.getMainNode()){i.width=r.selectedGroup.getMainNode().getWidth()+2*r.selectedGroup.padding;i.height=r.selectedGroup.getMainNode().getHeight()}else{i.width=Math.floor(Math.random()*(r.stage.getWidth()*.75-r.stage.getWidth()*.1)+r.stage.getWidth()*.1);i.height=Math.floor(Math.random()*(r.stage.getHeight()*.75-r.stage.getHeight()*.1)+r.stage.getHeight()*.1)}}if(e.hasOwnProperty("gradient")){var s=[0,"gray",1,"black"];if(e.gradient.hasOwnProperty("colors")&&e.gradient.hasOwnProperty("colorStops")){if(e.gradient.colors.length>0&&e.gradient.colorStops.length>0)s=[];for(var o=0;o<e.gradient.colors.length&&o<e.gradient.colorStops.length;o++){s.push(e.gradient.colorStops[o]);s.push(e.gradient.colors[o])}}var u;var a;var f;var l;var c=[[0,i.height/2,i.width,i.height/2],[i.width/2,0,i.width/2,i.height],[-i.width/2,0,i.width/2,0],[0,-i.height/2,0,i.height/2],[i.width/2,i.height/2,i.width,i.height]];var h=0;if(!e.gradient.hasOwnProperty("startX")||!e.gradient.hasOwnProperty("startY")||!e.gradient.hasOwnProperty("endX")||!e.gradient.hasOwnProperty("endY")){if(e.gradient.direction==="linear-horizontal")h=0;if(e.gradient.direction==="linear-vertical")h=1;if(i.curve===-1)h=h+2;if(e.gradient.direction==="radial")h=4;u=c[h][0];a=c[h][1];f=c[h][2];l=c[h][3]}else{u=e.gradient.startX;a=e.gradient.startY;f=e.gradient.endX;l=e.gradient.endY}if(e.gradient.hasOwnProperty("direction")){if(e.gradient.direction==="linear-vertical"||e.gradient.direction==="linear-horizontal"){i.fillLinearGradientStartPoint={x:u,y:a};i.fillLinearGradientEndPoint={x:f,y:l};i.fillLinearGradientColorStops=s;i.fillPriority="linear-gradient"}else if(e.gradient.direction==="radial"){var p;if(i.height>i.width)p=i.height/2;else p=i.width/2;i.fillRadialGradientStartRadius=3;i.fillRadialGradientEndRadius=p;if(i.curve>=0){i.fillRadialGradientStartPoint={x:i.width/2,y:i.height/2};i.fillRadialGradientEndPoint={x:i.width/2,y:i.height/2}}i.fillRadialGradientColorStops=s;i.fillPriority="radial-gradient"}else{i.fillPriority="color"}}}else{e.gradient={};e.gradient.direction="none"}if(i.curve>=0){t=new n.Shape(r._extendConfig({sceneFunc:function(e){e.beginPath();e.moveTo(i.curve,0);e.lineTo(i.width-i.curve,0);e.quadraticCurveTo(i.width,0,i.width,i.curve);e.lineTo(i.width,i.height-i.curve);e.quadraticCurveTo(i.width,i.height,i.width-i.curve,i.height);e.lineTo(i.curve,i.height);e.quadraticCurveTo(0,i.height,0,i.height-i.curve);e.lineTo(0,i.curve);e.quadraticCurveTo(0,0,i.curve,0);e.fillStrokeShape(this)}},i));t.setOffsetX(t.getWidth()/2);t.setOffsetY(t.getHeight()/2)}else if(i.curve==-1){t=new n.Ellipse(r._extendConfig({radius:{x:i.width/2,y:i.height/2},x:0,y:0,strokeWidth:2,draggable:false},i))}r.selectedGroup.ko.add(t);if(r.selectedGroup.parent==="root"){t.setX(r.stage.getWidth()/2);t.setY(r.stage.getHeight()/2)}else{if(!r.selectedGroup.getMainNode()&&i.x==="auto"&&i.y==="auto"){r.randomPos(t)}else if(i.x==="auto"&&i.y==="auto"){t.setX(r.selectedGroup.getMainNode().getWidth()/2);t.setY(r.selectedGroup.getMainNode().getHeight()/2)}}if(r.selectedGroup.getMainNode()){var d=r.selectedGroup.getMainNode();if(d.hasShadow()&&!t.hasShadow()){t.shadowOpacity(d.shadowOpacity());t.shadowOffsetX(d.shadowOffsetX());t.shadowOffsetY(d.shadowOffsetY());t.shadowBlur(d.shadowBlur());t.shadowColor(d.shadowColor())}d.shadowOpacity(0)}r.selectedGroup.copyValues(e);r.selectedGroup.shapeKO=t;r.selectedGroup.kineticToGroup();r.selectedGroup.updateMargins();r.relayer(r.selectedGroup);r.mainLayer.batchDraw()};this.randomPos=function(e){var t=this.stage.getWidth()-e.getWidth()/2;var n=e.getWidth()/2;var r=Math.floor(Math.random()*(t-n)+n);t=this.stage.getHeight()-e.getHeight()/2;n=e.getHeight()/2;var i=Math.floor(Math.random()*(t-n)+n);o.x=r-e.getWidth()/2;o.y=i-e.getHeight()/2;e.setX(e.getWidth()/2);e.setY(e.getHeight()/2);e.getParent().setAbsolutePosition({x:o.x,y:o.y});return o};this.reorder=function(e,t){if(e!="root"&&t!="root"){if(t.parent==="root"){}else{var n=t.parent;e.subgroups.push(t);if(n.subgroups.indexOf(t)>-1)n.subgroups.splice(n.subgroups.indexOf(t),1);var r=e.ko.getAbsolutePosition();var i=t.ko.getAbsolutePosition();var s=n.ko.getZIndex();t.ko.remove();e.ko.add(t.ko);t.ko.setZIndex(s+1);t.ko.setX(i.x-r.x);t.ko.setY(i.y-r.y);t.rect.x=i.x-r.x;t.rect.y=i.y-r.y;canvas.mainLayer.batchDraw()}}};this.group=function(e,t){for(var n=0;n<this.secondaryGroups.length;n++){this.reorder(e,this.secondaryGroups[n])}};this.dismantle=function(e){var t=[];var n=0;e.remove();while(e.subgroups.length>0){t.append(dismantle(e.subgroups[n]))}t.append(e);return t};this.delete=function(e){if(!e)e=this.selectedGroup;var t=e.subgroups;var n=e.parent;var r=0;if(n==="root"){n=t[0];r=1}while(r<t.length){this.reorder(n,t[r]);r++}e.ko.destroy();n.subgroups.splice(n.subgroups.indexOf(e),1)};this.scale=function(e,t){var n=true;var r=true;if(this.hasOwnProperty("rootGroup")){n=this.checkForMinWidth(this.rootGroup);r=this.checkForMinHeight(this.rootGroup)}if(e===undefined&&this.hasOwnProperty("rootGroup"))e=this.rootGroup.rect.width;if(t===undefined&&this.hasOwnProperty("rootGroup"))t=this.rootGroup.rect.height;var i=e-this.stage.getWidth();var s=t-this.stage.getHeight();this.border.setWidth(e);this.border.setHeight(t);this.stage.setWidth(e);this.stage.setHeight(t);if(this.hasOwnProperty("rootGroup"))this.groupScale(this.rootGroup,i,s)};this.checkForMinWidth=function(e){var t=true;if(e.hasOwnProperty("shapeKO")){if(e.shapeKO.getWidth()<=20||e.shapeKO.getWidth()<=e.curve*2){return false}else{if(e.hasOwnProperty("subgroups")){for(var n=0;n<e.subgroups.length;n++){if(!this.checkForMinWidth(e.subgroups[n]))return false}}return true}}};this.checkForMinHeight=function(e){};this.calculateReachMin;this.groupScale=function(e,t,n){if(e.hasOwnProperty("resizingMask")){var r=(e.resizingMask&1)===1;var i=(e.resizingMask&2)===2;var s=(e.resizingMask&4)===4;var o=(e.resizingMask&8)===8;var u=(e.resizingMask&16)===16;var a=(e.resizingMask&32)===32;if(e.hasOwnProperty("shapeKO")){var f=e.shapeKO.getAbsolutePosition().x+e.shapeKO.getWidth()/2;var l=this.stage.getWidth()-(e.shapeKO.getAbsolutePosition().x+e.shapeKO.getWidth()/2);var c=e.shapeKO.getAbsolutePosition().y+e.shapeKO.getHeight()/2;var h=this.stage.getHeight()-(e.shapeKO.getAbsolutePosition().y+e.shapeKO.getHeight()/2)}if(e.resizingMask!=0){if(r&&!i&&!s){e.ko.setX(e.ko.x()+t)}else if(!r&&i&&!s){e.editShape({width:e.shapeKO.getWidth()+t});e.ko.setX(e.ko.x()+t/2)}else if(r&&i&&!s){e.editShape({width:e.shapeKO.getWidth()+t/2});e.ko.setX(e.ko.x()+t)}else if(r&&!i&&s){e.ko.setX(e.ko.x()+t/2)}else if(!r&&i&&s){e.editShape({width:e.shapeKO.getWidth()+t/2});e.ko.setX(e.ko.x()+t/4)}else if(r&&i&&s){e.editShape({width:e.shapeKO.getWidth()+t/3});e.ko.setX(e.ko.x()+t/3)}if(o&&!u&&!a){e.ko.setY(e.ko.y()+n)}else if(!o&&u&&!a){e.editShape({height:e.shapeKO.getHeight()+n});e.ko.setY(e.ko.y()+n/2)}else if(o&&u&&!a){e.editShape({height:e.shapeKO.getHeight()+n/2});e.ko.setY(e.ko.y()+n/2)}else if(o&&!u&&a){e.ko.setY(e.ko.y()+n/2)}else if(!o&&u&&a){e.editShape({height:e.shapeKO.getHeight()+n/2});e.ko.setY(e.ko.y()+n/4)}else if(o&&u&&a){e.editShape({height:e.shapeKO.getHeight()+n/3});e.ko.setY(e.ko.y()+n/3)}}if(e.getMainNode())e.scaleMainNode(t,n);if(e.hasOwnProperty("subgroups")){for(var p=0;p<e.subgroups.length;p++){this.groupScale(e.subgroups[p],t,n)}}}};this.save=function(){};this.load=function(e){this.addSubgroup(e);var t=this.selectedGroup;if(e.hasOwnProperty("color")){if(t.color[0]=="#")t.color=this.hexToRGBAString(t.color,t.alpha||0);this.addShape(t)}if(e.hasOwnProperty("image")){if(e.image.hasOwnProperty("imageId"))this.addImage(t.image.imageId,t);else if(e.image.hasOwnProperty("url"))this.addImage(t.image.url,t)}else if(e.hasOwnProperty("text")){this.addText(t)}if(e.hasOwnProperty("subgroups")){for(var n=0;n<e.subgroups.length;n++){this.load(e.subgroups[n]);this.selectedGroup=t}}};this.relayer=function(e){if(e.hasOwnProperty("ko")){if(e.ko.hasOwnProperty("children")){if(e.getMainNode())e.getMainNode().moveToBottom();if(e.hasOwnProperty("shapeKO"))e.shapeKO.moveToBottom()}}}}};if(typeof define==="function"&&define.amd){define("sandbox",["jquery","kinetic","p","underscore"],function(e,t){return r(e,t)})}else{window.Sandbox=r($,Kinetic)}})()